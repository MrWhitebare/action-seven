var A=Object.defineProperty;var N=(l,r,e)=>r in l?A(l,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[r]=e;var c=(l,r,e)=>(N(l,typeof r!="symbol"?r+"":r,e),e);import{i as W,o as $,s as L,r as j,Q as p,j as s,ak as C,a8 as I,B as U,a9 as w}from"./index-D08lrevy.js";import{u as H}from"./userService-D6KOpzhx.js";import{S as M,d as R}from"./index-C_IlPSzD.js";import{u as D}from"./useLocalObservable-BcqWuwqo.js";import{A as _}from"./index-CCBg2zbs.js";import{I as T}from"./index-CFKDrSJV.js";import"./index-BHN1QtYZ.js";const m=class m{log(r,e){m.console}closeConsole(){m.console=!1}};c(m,"console",!0);let k=m;class O extends k{constructor(){super(...arguments);c(this,"listeners",{})}addEventListener(e,i){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].indexOf(i)===-1&&this.listeners[e].push(i)}removeEventListener(e){this.listeners[e]=[]}dispatchEvent(e,i){const d=this.listeners[e]||[];d.length!==0&&d.forEach(u=>{u.call(this,i)})}}class Y extends O{constructor(e){super();c(this,"url","");c(this,"socket",null);c(this,"reconnectAttempts",0);c(this,"maxReconnectAttempts",5);c(this,"reconnectInterval",1e4);c(this,"heartbeatInterval",1e3*30);c(this,"heartbeatTimer");c(this,"stopWs",!1);this.url=e}onopen(e){this.addEventListener("open",e)}onmessage(e){this.addEventListener("message",e)}onclose(e){this.addEventListener("close",e)}onerror(e){this.addEventListener("error",e)}send(e){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(e):console.error("[WebSocket] 未连接")}connect(){this.reconnectAttempts===0&&this.log("WebSocket",`初始化连接中...          ${this.url}`),!(this.socket&&this.socket.readyState===WebSocket.OPEN)&&(this.socket=new WebSocket(this.url),this.socket.onopen=e=>{this.stopWs=!1,this.reconnectAttempts=0,this.startHeartbeat(),this.log("WebSocket",`连接成功,等待服务端数据推送[onopen]...     ${this.url}`),this.dispatchEvent("open",e)},this.socket.onmessage=e=>{this.dispatchEvent("message",e),this.startHeartbeat()},this.socket.onclose=e=>{this.reconnectAttempts===0&&this.log("WebSocket",`连接断开[onclose]...    ${this.url}`),this.stopWs||this.handleReconnect(),this.dispatchEvent("close",e)},this.socket.onerror=e=>{this.reconnectAttempts===0&&this.log("WebSocket",`连接异常[onerror]...    ${this.url}`),this.closeHeartbeat(),this.dispatchEvent("error",e)})}handleReconnect(){this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,this.log("WebSocket",`尝试重连... (${this.reconnectAttempts}/${this.maxReconnectAttempts})       ${this.url}`),setTimeout(()=>{this.connect()},this.reconnectInterval)):(this.closeHeartbeat(),this.log("WebSocket",`最大重连失败，终止重连: ${this.url}`))}close(){this.socket&&(this.stopWs=!0,this.socket.close(),this.socket=null,this.removeEventListener("open"),this.removeEventListener("message"),this.removeEventListener("close"),this.removeEventListener("error")),this.closeHeartbeat()}startHeartbeat(){this.stopWs||(this.heartbeatTimer&&this.closeHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.socket?(this.socket.send(JSON.stringify({type:"heartBeat",data:{}})),this.log("WebSocket","送心跳数据...")):console.error("[WebSocket] 未连接")},this.heartbeatInterval))}closeHeartbeat(){clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0}}const B="_left_1jxl1_8",P="_active_1jxl1_28",Q="_divider_1jxl1_32",F="_right_1jxl1_35",J="_reader_1jxl1_54",q="_sender_1jxl1_55",z="_tip_1jxl1_66",G="_msg_1jxl1_41",K="_btn_1jxl1_93",a={"we-chat-ui":"_we-chat-ui_1jxl1_1",left:B,"user-item":"_user-item_1jxl1_14",active:P,divider:Q,right:F,"msg-container":"_msg-container_1jxl1_41","msg-item":"_msg-item_1jxl1_46",reader:J,sender:q,tip:z,msg:G,"send-msg":"_send-msg_1jxl1_89",btn:K},ne=W("chat","user")($(l=>{const{user:r,chat:e}=l,i=D(()=>({users:[],loading:!1,activeId:null,msgInfo:null,avatars:{},get isActive(){return typeof this.activeId=="string"&&this.activeId!==""&&typeof this.msgInfo=="string"&&this.msgInfo!==""},setUsers(t){this.users=t},getUserData(){this.loading=!0,H.getAllUsers().then(t=>{let{rows:o}=t,h=[];o.forEach(n=>{n.nickname!==(r==null?void 0:r.userName)&&h.push(n),this.avatars[n.id]=n.nickname.substring(0,1).toLocaleUpperCase()}),this.users=h}).catch(t=>L.error("获取用户数据失败！"+t)).finally(()=>this.loading=!1)},setActiveUser(t){this.activeId=t},setMsgInfo(t){this.msgInfo=t}})),d=j.useRef();j.useEffect(()=>{i.getUserData();let t=localStorage.getItem("userInfo");const o=p.parse(t||""),h={role:"sender",userId:o.id},n=new Y(`ws://localhost:5000/webSockets?${p.stringify(h)}`);n.connect(),n.onclose(()=>{}),n.onerror(()=>{}),n.onmessage(f=>{const x=f.data,[b,v,g]=x.split("|"),y=p.parse(g);e==null||e.addItem(v,{...y,type:"reader"})}),n.onopen(()=>{}),d.current=n},[]);const u=t=>()=>{i.setActiveUser(t)},E=()=>{var n;const{msgInfo:t,activeId:o}=i;let h={type:"sender",msg:t,time:R().format("YYYY-MM-DD HH:mm:ss")};(n=d.current)==null||n.send(`message|${o}|${p.stringify(h)}`),e==null||e.addItem(o,h)},S=()=>{var n;if(!i.activeId)return s.jsxs(j.Fragment,{children:[s.jsx(I,{children:"分割线"}),s.jsx(w,{})]});const{activeId:t}=i,o=e==null?void 0:e.getMsgList(t),h=(n=r==null?void 0:r.userName)==null?void 0:n.substring(0,1).toLocaleUpperCase();return o==null?void 0:o.map((f,x)=>{const{msg:b,time:v,type:g}=f;return s.jsxs("div",{className:a["msg-item"],children:[g==="reader"&&s.jsxs("div",{className:a.reader,children:[s.jsx(_,{style:{backgroundColor:"#fde3cf",color:"#f56a00"},children:i.avatars[t]}),s.jsx("div",{className:a.msg,children:b}),s.jsx("div",{className:a.tip,children:v})]}),g==="sender"&&s.jsxs("div",{className:a.sender,children:[s.jsx("div",{className:a.msg,children:b}),s.jsx(_,{style:{backgroundColor:"#bfc",color:"#f56a00"},children:h}),s.jsx("div",{className:a.tip,children:v})]})]},x+1)})};return s.jsxs("div",{className:a["we-chat-ui"],children:[s.jsx("div",{className:a.left,children:s.jsx(C,{active:!0,loading:i.loading,children:i.users.map((t,o)=>s.jsxs("div",{className:`${a["user-item"]} ${i.activeId===t.id&&a.active}`,onClick:u(t.id),children:[s.jsx(_,{src:`https://api.dicebear.com/7.x/miniavs/svg?seed=${o+1}`}),s.jsx("div",{children:t.nickname})]},t.id))})}),s.jsx(I,{className:a.divider,type:"vertical",dashed:!0,variant:"dotted"}),s.jsxs("div",{className:a.right,children:[s.jsx("div",{className:a["msg-container"],children:S()}),s.jsxs(M.Compact,{className:a["send-msg"],children:[s.jsx(T,{placeholder:"请输入消息",disabled:!i.activeId,onChange:t=>i.setMsgInfo(t.target.value)}),s.jsx(U,{className:a.btn,type:"primary",disabled:!i.isActive,onClick:E,children:"发送"})]})]})]})}));export{ne as default};
